var hello=function(){var _jsonp_counter=0;var listeners={};var services={google:{name:"Google Plus",uri:{auth:"https://accounts.google.com/o/oauth2/auth",me:"people/me?pp=1",base:"https://www.googleapis.com/plus/v1/"},scope:{basic:"https://www.googleapis.com/auth/plus.me"},wrap:{me:function(o){if(o.id){o.last_name=o.name.familyName;o.first_name=o.name.givenName;o.picture=o.image.url;o.name=o.displayName}return o}}},windows:{name:"Windows live",uri:{auth:"https://oauth.live.com/authorize",base:"https://apis.live.net/v5.0/"},
scope:{basic:"wl.basic"},wrap:{me:function(o){if(o.id){o.email=o.emails?o.emails.preferred:null;o.picture="https://apis.live.net/v5.0/"+o.id+"/picture?access_token="+hello.getAuthResponse("windows").access_token}return o}}},facebook:{name:"Facebook",uri:{auth:"http://www.facebook.com/dialog/oauth/",base:"https://graph.facebook.com/"},scope:{basic:"email,offline_access"},wrap:{me:function(o){if(o.id)o.picture="http://graph.facebook.com/"+o.id+"/picture";return o}}},knarly:{name:"Knarly",autologin:true,
id:window.location.host,uri:{auth:function(qs){var url="/knarly.net/oauth";var service=hello.service(),session=hello.getAuthResponse(service);if(session&&"access_token"in session){qs.access_token=session.access_token;qs.provider=service}return url+"?"+_param(qs)},base:"/knarly.net/api/"},scope:{basic:""},wrap:{}}};var hello={service:function(service){if(typeof service!=="undefined")return _store("sync_service",service);return _store("sync_service")},init:function(o){for(var x in o)if(o.hasOwnProperty(x))services[x].id=
o[x];var _diff={};(function self(){for(var x in services)if(services.hasOwnProperty(x)){var session=hello.getAuthResponse(x);var token=session?session.access_token:null;var evt="";if(_diff[x]===token)continue;else{if(!token)evt="auth.logout."+x;else evt="auth.login."+x;hello.trigger(evt,{network:x,authResponse:session})}_diff[x]=token}setTimeout(self,1E3)})()},login:function(service,callback,display){var url;var p=_arguments({service:"s!",callback:"f",display:"s"},arguments);p.display=p.display||
"popup";if(typeof p.service==="string"){var qs={client_id:services[p.service].id,redirect_uri:window.location.href,response_type:"token",scope:services[p.service].scope.basic,state:p.service,display:p.display};if(typeof services[p.service].uri.auth==="function")url=services[p.service].uri.auth(qs);else url=services[p.service].uri.auth+"?"+_param(qs);if(p.callback)this.subscribe("auth.login."+p.service,function self(){hello.unsubscribe("auth.login."+p.service,self);p.callback.apply(this,arguments)});
if(p.display==="none")_append("iframe",{src:url,style:{height:0,width:0,position:"absolute",top:0,left:0}},document.body);else if(p.display==="popup")window.open(url,"name","height=400,width=450,left="+(window.innerWidth-450)/2+",top="+(window.innerHeight-400)/2);else window.location=url}else log("Please specify a service.")},logout:function(s,callback){if(s&&_store(s)){_store(s,"");callback?callback():null}else if(!s){for(var x in services)if(services.hasOwnProperty(x))hello.logout(x);hello.service(false);
callback?callback():null}else log(s+" had no session")},api:function(){var p=_arguments({path:"s!",method:"s",data:"o",callback:"f"},arguments);p.method=p.method||"get";p.data=p.data||{};p.path=p.path.replace(/^\//,"");var a=(p.path.split("/",2)||[])[0].toLowerCase();var service;if(a in services){service=a;p.path=p.path.replace(/^.*?\//,"")}else service=this.service();p.callback=p.callback||function(){};log("API:",p);var o=services[service];if(!o){log("No user");p.callback(false);return}var callback=
o.wrap&&p.path in o.wrap?function(r){log(p.path,r);p.callback(o.wrap[p.path](r))}:p.callback;if(!(p.path in o.uri)||o.uri[p.path]!==false){var url=o.uri.base+(p.path in o.uri?o.uri[p.path]:p.path),session=this.getAuthResponse(service),token=session?session.access_token:null;var qs={callback:"?"};if(token)qs.access_token=token;if(p.method.toLowerCase()!=="get")p.data={data:JSON.stringify(p.data),method:p.method.toLowerCase()};if(session&&"expires"in session&&session.expires<(new Date).getTime()/1E3||
!session&&o.autologin){log("Callback");hello.login(service,function(bool){_jsonp(url+(url.indexOf("?")>-1?"&":"?")+_param(qs),p.data,callback)},"none")}else if("requestHandler"in o)o.requestHandler(uri,qs,p.data,callback);else _jsonp(url+(url.indexOf("?")>-1?"&":"?")+_param(qs),p.data,callback)}else log('The path "'+p.path+'" is not recognised')},getAuthResponse:function(service){return _store(service||this.service())},subscribe:function(evt,callback){var p=_arguments({evt:"s!",callback:"f!"},arguments);
if(!p)return false;listeners[p.evt]=[p.callback].concat(listeners[p.evt]||[]);log("Sub",evt)},unsubscribe:function(evt,callback){log("Unsubscribe",evt,callback);var p=_arguments({evt:"s!",callback:"f!"},arguments);if(!p)return false;for(var i=0;i<listeners[p.evt].length;i++)if(listeners[p.evt][i]===callback)listeners[p.evt]=listeners[p.evt].splice(i,1)},trigger:function(evt,data){log("Trigger",evt,JSON.stringify(listeners));for(var x in listeners)if(listeners.hasOwnProperty(x))if(evt.indexOf(x)>-1)for(var i=
0;i<listeners[x].length;i++)listeners[x][i].call(this,data)},_param:_param,_store:_store};var p=_param(window.location.hash);if(p&&"access_token"in p&&"state"in p&&p.state in services){if(parseInt(p.expires_in,10)===0)p.expires_in=3600*24*7*52;_store(p.state,{access_token:p.access_token,expires_in:parseInt(p.expires_in,10),expires:(new Date).getTime()/1E3+parseInt(p.expires_in,10)});hello.service(p.state);window.close();log("Trying to close window");return}return hello;function log(){if(typeof console===
"undefined"||typeof console.log==="undefined")return;if(typeof console.log==="function")console.log.apply(console,arguments);else console.log(Array.prototype.slice.call(arguments))}function _param(s){var b,a={},m;if(typeof s==="string"){m=s.replace(/.*[#\?]/,"").match(/([^=\/\&]+)=([^\/\&]+)/g);if(m)for(var i=0;i<m.length;i++){b=m[i].split("=");a[b[0]]=decodeURIComponent(b[1])}return a}else{var o=s;a=[];for(var x in o)if(o.hasOwnProperty(x))if(o.hasOwnProperty(x))a.push([x,o[x]==="?"?"?":encodeURIComponent(o[x])].join("="));
return a.join("&")}}function _store(name,value,days){var hello=JSON.parse(localStorage.getItem("hello"))||{};if(name&&typeof value==="undefined")return hello[name];else if(name&&value==="")delete hello[name];else if(name)hello[name]=value;else return hello;localStorage.setItem("hello",JSON.stringify(hello));return hello}function _arguments(o,args){var p={},i=0,t=null;for(var x in o)if(o.hasOwnProperty(x)){t=typeof args[i];if(typeof o[x]==="function"&&o[x].test(args[i])||typeof o[x]==="string"&&(o[x][0]===
"s"&&t==="string"||o[x][0]==="o"&&t==="object"||o[x][0]==="i"&&t==="number"||o[x][0]==="a"&&t==="object"||o[x][0]==="f"&&t==="function"))p[x]=args[i++];else if(typeof o[x]==="string"&&o[x][1]==="!"){log("Whoops! "+x+" not defined");return false}}return p}function _append(node,attr,target){var n=typeof node==="string"?document.createElement(node):node;if(typeof attr==="object")if("tagName"in attr)target=attr;else for(var x in attr)if(attr.hasOwnProperty(x))if(typeof attr[x]==="object")for(var y in attr[x])n[x][y]=
attr[x][y];else n[x]=attr[x];if(typeof target==="object")target.appendChild(n);else if(typeof target==="string"){log(target);document.getElementsByTagName(target)[0].appendChild(n)}return n}function _jsonp(path,data,callback){path+=(path.indexOf("?")===-1?"?":"&")+_param(data);var cb_name="__lx_jsonp"+_jsonp_counter++,bool=0,head=document.getElementsByTagName("head")[0],operafix,script,result=false,cb=function(){if(!bool++)window.setTimeout(function(){callback(result);head.removeChild(script)},0)};
window[cb_name]=function(json){result=json;delete window[cb_name]};script=_append("script",{id:cb_name,name:cb_name,src:path.replace(new RegExp("=\\?(&|$)"),"="+cb_name+"$1"),async:true,onload:cb,onerror:cb,onreadystatechange:function(){if(/loaded|complete/i.test(this.readyState))cb()}});if(window.navigator.userAgent.toLowerCase().indexOf("opera")>-1){operafix=_append("script",{text:"document.getElementById('"+cb_name+"').onerror();"});script.async=false}window.setTimeout(cb,6E4);head.appendChild(script);
if(operafix)head.appendChild(operafix)}function _post(uri,data,callback){}}();