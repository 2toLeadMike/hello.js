/* hello.js; Copyright held by Andrew Dodson (@mr_switch), GPL and MIT license, do not remove this */
var hello=function(){var _jsonp_counter=0;var listeners={};var shy={position:"absolute",left:"-1000px",bottom:0,height:"1px",width:"1px"};var _timeout=2E4;var _initstarted=false;var _options={redirect_uri:window.location.href.split("#")[0],response_type:"token",display:"popup",state:""};var _services={google:{name:"Google Plus",uri:{auth:"https://accounts.google.com/o/oauth2/auth",me:"plus/v1/people/me?pp=1",base:"https://www.googleapis.com/","me/friends":"https://www.google.com/m8/feeds/contacts/default/full?alt=json&max-results=1000"},
scope:{basic:"https://www.googleapis.com/auth/plus.me",email:"",birthday:"",events:"",photos:"https://picasaweb.google.com/data/",videos:"http://gdata.youtube.com",friends:"https://www.google.com/m8/feeds",publish:"",create_event:"",offline_access:""},scope_delim:" ",wrap:{me:function(o){if(o.id){o.last_name=o.name.familyName;o.first_name=o.name.givenName;o.picture=o.image.url;o.name=o.displayName}return o},"me/friends":function(o){var r=[];if("feed"in o&&"entry"in o.feed){for(var i=0;i<o.feed.entry.length;i++){var a=
o.feed.entry[i];r.push({id:a.id.$t,name:a.title.$t,email:a.gd$email&&a.gd$email.length>0?a.gd$email[0].address:null,updated:a.updated.$t,picture:a.link&&a.link.length>0?a.link[0].href+"?access_token="+hello.getAuthResponse("google").access_token:null})}return{name:o.feed.title.$t,updated:o.feed.updated.$t,data:r}}return o}}},windows:{name:"Windows live",uri:{auth:"https://oauth.live.com/authorize",base:"https://apis.live.net/v5.0/"},scope:{basic:"wl.signin,wl.basic",email:"wl.emails",birthday:"wl.birthday",
events:"wl.calendars",photos:"wl.photos",videos:"wl.photos",friends:"",publish:"wl.share",create_event:"wl.calendars_update,wl.events_create",offline_access:"wl.offline_access"},wrap:{me:function(o){if(o.id){o.email=o.emails?o.emails.preferred:null;o.picture="https://apis.live.net/v5.0/"+o.id+"/picture?access_token="+hello.getAuthResponse("windows").access_token}return o},"me/friends":function(o){if("data"in o)for(var i=0;i<o.data.length;i++)o.data[i].picture="https://apis.live.net/v5.0/"+o.data[i].id+
"/picture?access_token="+hello.getAuthResponse("windows").access_token;return o}},preprocess:function(p){if(p.method.toLowerCase()!=="get"){p.path={"me/feed":"me/share"}[p.path]||p.path;p.method="get";p.data.method="post"}return p}},facebook:{name:"Facebook",uri:{auth:"http://www.facebook.com/dialog/oauth/",base:"https://graph.facebook.com/","me/share":"me/feed"},scope:{basic:"",email:"email",birthday:"user_birthday",events:"user_events",photos:"user_photos,user_videos",videos:"user_photos,user_videos",
friends:"",publish:"publish_stream",create_event:"create_event",offline_access:"offline_access"},wrap:{me:function(o){if(o.id)o.picture="http://graph.facebook.com/"+o.id+"/picture";return o},"me/friends":function(o){if("data"in o)for(var i=0;i<o.data.length;i++)o.data[i].picture="http://graph.facebook.com/"+o.data[i].id+"/picture";return o}},preprocess:function(p){if(p.method.toLowerCase()!=="get"){p.data.method=p.method.toLowerCase();p.method="get"}return p}},knarly:{name:"Knarly",id:window.location.host,
uri:{auth:"http://oauth.knarly.com/",base:"http://api.knarly.com/"},scope:{basic:""},wrap:{},preprocess:function(p){if(p.method.toLowerCase()!=="get"){if(p.method==="post"&&_isArray(p.data))p.data={json:JSON.stringify(p.data)};p.data.method=p.method.toLowerCase();p.method="get"}if(!hello.getAuthResponse("knarly"))p.data.client_id=this.id;return p}}};var hello={service:function(service){if(typeof service!=="undefined")return _store("sync_service",service);return _store("sync_service")},init:function(services,
opts,timeout){var p=_arguments({services:"o!",opts:"o",timeout:"i"},arguments);for(var x in p.services)if(p.services.hasOwnProperty(x))if(typeof p.services[x]!=="object")p.services[x]={id:p.services[x]};_services=_merge(_services,p.services);if(p.opts)_options=_merge(_options,p.opts);if(p.timeout)_timeout=p.timeout;if(_initstarted)return false;else _initstarted=true;var old_tokens={},pending={};(function self(){var error=_store("error");if(error&&"callback"in error&&error.callback in listeners){var cb=
error.callback;delete error.callback;_store("error",error);hello.trigger(cb,error)}for(var x in _services)if(_services.hasOwnProperty(x)){var session=hello.getAuthResponse(x);var token=session?session.access_token:null;var evt="";if(session&&"callback"in session&&session.callback in listeners){var cb=session.callback;delete session.callback;_store(x,session);hello.trigger(cb,{network:x,authResponse:session})}if(session&&"expires"in session&&(!(x in pending)||pending[x]<(new Date).getTime()/1E3)&&
session.expires<(new Date).getTime()/1E3){log(x+" has expired trying to resignin");hello.login(x,{display:"none"});pending[x]=(new Date).getTime()/1E3+600}if(old_tokens[x]===token)continue;else{if(!token)evt="auth.logout."+x;else evt="auth.login."+x;hello.trigger(evt,{network:x,authResponse:session})}old_tokens[x]=token}setTimeout(self,1E3)})()},login:function(service,opts,callback){var url,p=_arguments({service:"s!",options:"o",callback:"f"},arguments);p.options=_merge(_options,p.options||{});if(typeof p.service===
"string"){var provider=_services[p.service],callback_id="";if(p.callback){callback_id=""+Math.round(Math.random()*1E9);this.subscribe(callback_id,function self(){hello.unsubscribe(callback_id,self);p.callback.apply(this,arguments)})}var qs=_merge(p.options,{client_id:provider.id,scope:provider.scope.basic,state:p.service+"."+p.options.display+"."+callback_id+"."+p.options.state});var scope=p.options.scope;if(scope){if(typeof scope!=="string")scope=scope.join(",");qs.scope=(qs.scope+","+scope).replace(/[^,\s]+/ig,
function(m){return m in provider.scope?provider.scope[m]:m});qs.scope=_unique(qs.scope.split(/,+/)).join(provider.scope_delim||",")}if(qs.redirect_uri.indexOf("/")===0)qs.redirect_uri=window.location.protocol+"//"+window.location.host+qs.redirect_uri;else if(!qs.redirect_uri.match(/^https?\:\/\//))qs.redirect_uri=(window.location.href.replace(/#.*/,"").replace(/\/[^\/]+$/,"/")+qs.redirect_uri).replace(/\/\.\//g,"/").replace(/\/[^\/]+\/\.\.\//g,"/");url=provider.uri.auth+"?"+_param(qs);if(qs.display===
"none")_append("iframe",{src:url,style:shy},"body");else if(qs.display==="popup")window.open(url,"name","height=400,width=450,left="+(window.innerWidth-450)/2+",top="+(window.innerHeight-400)/2);else window.location=url}else log("Please specify a service.");return{url:url,method:qs.display}},logout:function(s,callback){if(s&&_store(s))_store(s,"");else if(!s){for(var x in _services)if(_services.hasOwnProperty(x))hello.logout(x);hello.service(false)}else log(s+" had no session");if(callback)callback(false)},
api:function(){var p=_arguments({path:"s!",method:"s",data:"o",timeout:"i",callback:"f"},arguments);p.method=(p.method||"get").toLowerCase();p.data=p.data||{};p.path=p.path.replace(/^\/+/,"");var a=(p.path.split("/",2)||[])[0].toLowerCase();var service;if(a in _services){service=a;var reg=new RegExp("^"+a+"/?");p.path=p.path.replace(reg,"")}else service=this.service();p.callback=p.callback||function(){};_timeout=p.timeout||_timeout;log("API:",p);var o=_services[service];if(!o){log("No user");p.callback(false);
return}var callback=o.wrap&&p.path in o.wrap?function(r){log(p.path,r);p.callback(o.wrap[p.path](r))}:p.callback;if("preprocess"in o)p=o.preprocess(p);if(!(p.path in o.uri)||o.uri[p.path]!==false){var url=p.path in o.uri?o.uri[p.path]:p.path,session=this.getAuthResponse(service),token=session?session.access_token:null;if(!url.match(/^https?:\/\//))url=o.uri.base+url;var qs={};if(token)qs.access_token=token;var request=function(){url+=url.indexOf("?")>-1?"&":"?";if(p.method==="post"){qs.channelUrl=
window.location.href;var req=_post(url+_param(qs),p.data,callback);return{url:req,method:"POST",data:p.data}}else{qs.callback="?";var req=_jsonp(url+_param(qs),p.data,callback);return{url:req,method:"JSONP"}}};if(session&&"expires"in session&&session.expires<(new Date).getTime()/1E3||!session&&o.autologin){log("Callback");hello.login(service,{display:"none"},function(r){if(typeof r==="object"&&"error"in r){callback(r);return}request()});return{status:"Signing in"}}else return request()}else log('The path "'+
p.path+'" is not recognised')},getAuthResponse:function(service){return _store(service||this.service())},subscribe:function(evt,callback){log("Subscribed",evt,callback);var p=_arguments({evt:"s!",callback:"f!"},arguments);if(!p)return false;listeners[p.evt]=[p.callback].concat(listeners[p.evt]||[])},unsubscribe:function(evt,callback){log("Unsubscribe",evt,callback);var p=_arguments({evt:"s!",callback:"f!"},arguments);if(!p)return false;for(var i=0;i<listeners[p.evt].length;i++)if(listeners[p.evt][i]===
callback)listeners[p.evt]=listeners[p.evt].splice(i,1)},trigger:function(evt,data){log("Trigger",evt,JSON.stringify(listeners));for(var x in listeners)if(listeners.hasOwnProperty(x))if(evt.indexOf(x)>-1)for(var i=0;i<listeners[x].length;i++)listeners[x][i].call(this,data)},_param:_param,_store:_store,_append:_append};var p=_param(window.location.hash);if(!p)p=_param(window.location.search);if(p&&"state"in p){var a=p.state.split(".");p.state=a[0];if(a.length>0)p.display=a[1];if("access_token"in p&&
p.state in _services){if(parseInt(p.expires_in,10)===0)p.expires_in=3600*24*7*52;_store(p.state,{access_token:p.access_token,expires_in:parseInt(p.expires_in,10),expires:(new Date).getTime()/1E3+parseInt(p.expires_in,10),callback:a[2]});hello.service(p.state);if(!("display"in p)||p.display!=="page"){window.close();log("Trying to close window");return}}else if("error"in p&&p.state in _services){_store("error",{error:p.error,error_message:p.error_message||p.error_description,callback:a[2],state:p.state});
if(!("display"in p)||p.display!=="page"){window.close();log("Trying to close window");return}}}return hello;function log(){if(typeof console==="undefined"||typeof console.log==="undefined")return;if(typeof console.log==="function")console.log.apply(console,arguments);else console.log(Array.prototype.slice.call(arguments))}function _isArray(o){return Object.prototype.toString.call(o)==="[object Array]"}function _param(s){var b,a={},m;if(typeof s==="string"){m=s.replace(/^[\#\?]/,"").match(/([^=\/\&]+)=([^\&]+)/g);
log(m);if(m)for(var i=0;i<m.length;i++){b=m[i].split("=");a[b[0]]=decodeURIComponent(b[1])}return a}else{var o=s;a=[];for(var x in o)if(o.hasOwnProperty(x))if(o.hasOwnProperty(x))a.push([x,o[x]==="?"?"?":encodeURIComponent(o[x])].join("="));return a.join("&")}}function _store(name,value,days){var hello=JSON.parse(localStorage.getItem("hello"))||{};if(name&&typeof value==="undefined")return hello[name];else if(name&&value==="")delete hello[name];else if(name)hello[name]=value;else return hello;localStorage.setItem("hello",
JSON.stringify(hello));return hello}function _unique(a){if(typeof a!=="object")return[];var r=[];for(var i=0;i<a.length;i++)if(!a[i]||a[i].length===0||r.indexOf(a[i])!==-1)continue;else r.push(a[i]);return r}function _merge(a,b){var x,r={};if(typeof a==="object"&&typeof b==="object"){for(x in a)if(a.hasOwnProperty(x)){r[x]=a[x];if(x in b)r[x]=_merge(a[x],b[x])}for(x in b)if(b.hasOwnProperty(x))if(!(x in a))r[x]=b[x]}else r=b;return r}function _arguments(o,args){var p={},i=0,t=null,x=null;for(var x in o)if(o.hasOwnProperty(x))break;
if(args.length===1&&typeof args[0]==="object"&&o[x]!="o!")return args[0];for(x in o)if(o.hasOwnProperty(x)){t=typeof args[i];if(typeof o[x]==="function"&&o[x].test(args[i])||typeof o[x]==="string"&&(o[x][0]==="s"&&t==="string"||o[x][0]==="o"&&t==="object"||o[x][0]==="i"&&t==="number"||o[x][0]==="a"&&t==="object"||o[x][0]==="f"&&t==="function"))p[x]=args[i++];else if(typeof o[x]==="string"&&o[x][1]==="!"){log("Whoops! "+x+" not defined");return false}}return p}function _append(node,attr,target){var n=
typeof node==="string"?document.createElement(node):node;if(typeof attr==="object")if("tagName"in attr)target=attr;else for(var x in attr)if(attr.hasOwnProperty(x))if(typeof attr[x]==="object")for(var y in attr[x]){if(attr[x].hasOwnProperty(y))n[x][y]=attr[x][y]}else n[x]=attr[x];if(target==="body")(function self(){if(document.body)document.body.appendChild(n);else setTimeout(self,16)})();else if(typeof target==="object")target.appendChild(n);else if(typeof target==="string"){log(target);document.getElementsByTagName(target)[0].appendChild(n)}return n}
function _jsonp(path,data,callback){path+=(path.indexOf("?")===-1?"?":"&")+_param(data);var cb_name="__lx_jsonp"+_jsonp_counter++,bool=0,head=document.getElementsByTagName("head")[0],operafix,script,result={error:{message:"server_error",code:"server_error"}},cb=function(){if(!bool++)window.setTimeout(function(){callback(result);head.removeChild(script)},0)};window[cb_name]=function(json){result=json;delete window[cb_name]};script=_append("script",{id:cb_name,name:cb_name,src:path.replace(new RegExp("=\\?(&|$)"),
"="+cb_name+"$1"),async:true,onload:cb,onerror:cb,onreadystatechange:function(){if(/loaded|complete/i.test(this.readyState))cb()}});if(window.navigator.userAgent.toLowerCase().indexOf("opera")>-1){operafix=_append("script",{text:"document.getElementById('"+cb_name+"').onerror();"});script.async=false}window.setTimeout(function(){result={error:{message:"timeout",code:"timeout"}};cb()},_timeout);head.appendChild(script);if(operafix)head.appendChild(operafix);return script.src}function _post(uri,data,
callback){var ifm=_append("iframe",{id:"_"+Math.round(Math.random()*1E9),style:shy});var frm=_append("form",{method:"post",action:uri,target:ifm.id,style:shy});for(var x in data)if(data.hasOwnProperty(x))_append("input",{name:x,value:data[x]},frm);document.body.appendChild(ifm);document.body.appendChild(frm);frm.submit();return uri}}();