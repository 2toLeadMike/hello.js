<!DOCTYPE html>
<html>
<head>
	<title>hello.js+knarly - UnitTests</title>
	<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
	<link rel="stylesheet" href="../../_packages/document.css" />
<script>
//<![CDATA[
	var local = ( /local/.test(window.location.host) ? 1 : 0);
	function loadScript(a){
		for(var i=0;i<a.length;i++){
			document.write('<script src="'+a[i]+'"><\/script>');
		}
	}
	loadScript([['http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js','/_packages/jquery.js'][local]]);
	loadScript([['http://cdnjs.cloudflare.com/ajax/libs/knockout/2.0.0/knockout-min.js','/_packages/knockout.js'][local]]);
	loadScript([['http://cloud.github.com/downloads/SteveSanderson/knockout/jquery.tmpl.js','/_packages/jquery.tmpl.js'][local]]);
	
//]]>
</script>
	<link href="api_tests.css" rel="stylesheet"/>

	<script src="../../_packages/knockout-mapping.js"></script>
	<script src="../../_packages/document.js"></script>
	<script src="../hello.js"></script>

	<script src="knarly_unit_tests.js"></script>
	<script src="api_tests.js"></script>

	<script>
		hello.subscribe('auth.login',function(r){
			var network = r.network;

			hello.api(network+'/me',function(r){
				if(!r.name){
					return;
				}

				$('button.'+network).html('<img src="'+ r.picture +'"/>'+r.name);

			});

			var i = model.connections.length;
			model.connections.push({ token : ko.observable(r.authResponse.access_token), name : ko.observable(r.network) });

			model.tests.forEach(function(a){
				if("data" in a){
					var a = a.data.items();
					for(var j=0; j<a.length; j++){
						var o=a[j];
						console.log('provider_token' === o.key());
						if( 'provider_token' === o.key() && parseInt(o.value(),10) === i ){
							o.value(model.connections[i].token());
						}
						if( 'provider_name' === o.key() && parseInt(o.value(),10) === i ){
							o.value(model.connections[i].name());
						}
					}
				}
			});

		});

		// 
		$(function(){

			// Change the user
			$('input[name=clientId]').change(function(){
				// Init
				hello.init({
					knarly : this.value+'@'+window.location.hostname
				});
				//
				console.log(this.value+'.'+window.location.hostname);
			}).val(parseInt(Math.random()*100000,10)).trigger('change');


		});
	</script>
	<script src="auth.js"></script>

	<style>
	button.google,button.facebook,button.windows{
		border-radius:10px;
	}
	button.google img,button.facebook img,button.windows img{
		width:36px;
		vertical-align:middle;
		margin-right:10px;
	}
	</style>

</head>
<body>

	<header>
		<h1>hello.js+Knarly UnitTests</h1>
		<p>Test the knarly api with variations of GET,POST,PUT,DELETE commands</p>
	</header>

	<aside>
		<h2>Choose an arbitary clientId</h2>
		<p>This runs account creation scripts</p>
		<p><input type="text" name="clientId"/></p>
	</aside>

	<aside>
		<h2>Signin with OAuth's</h2>
		<p>Signin with three seperate Oauth providers, Google+, Windows and FaceBook in order to run tests</p>

		<button class="google" onclick="hello.login('google');">google</button>
<button class="facebook" onclick="hello.login('facebook');">facebook</button>
<button class="windows" onclick="hello.login('windows');">windows</button>

	</aside>

	<h2>Runtests</h2>
	<p>
		<button data-bind="click: executeTests">Run all tests</button>
	</p>
	<ul data-bind="foreach: tests">
		<h2 data-bind="text: section, visible:section "></h2>
		<p data-bind="text:aside, visible:aside"></p>
		<li data-bind="visible: name, attr:{ class : method }, css: { error : passed() === false, passed : passed() === true }">
			<header onclick="$(this).toggleClass('show')">
				<span class="method" data-bind="text:method"></span>
				<span class="path" data-bind="text:path"></span>
				<span class="name" data-bind="text:name"></span>
			</header>	
			<article>
				<div data-bind="visible: note">
					<h4>Notes</h4>
					<p data-bind="text:note"></p>
				</div>
				<div data-bind="visible: data.items().length">
					<h4>Parameters</h4>
					<table>
						<thead>
							<tr>
								<th>Name</th>
								<th>Value</th>
								<th></th>
							</tr>
						</thead>
						<tbody data-bind="foreach: data.items">
						    <tr>
						        <th><input type="text" data-bind="value:key" /></th>
						        <td><input type="text" data-bind="value:value" /></td>
						        <td><a href="javascript:void(0);" data-bind="click: function() { $parent.data.removeItem($data) }">Delete</a></td>
						    </tr>
						</tbody>
						<tfoot>
							<tr>
								<td colspan="3"><a href="javascript:void(0);" data-bind="click: data.addItem">Add item</a></td>
							</tr>
						</tfoot>
					</table>
				</div>
				<button data-bind="click: execute.bind($data,'knarly')">Try it out</button>
				<div data-bind="visible: expected">
					<h4>Expected</h4>
					<pre data-bind="beautify: expected"></pre>
				</div>
				<div data-bind="visible: request">
					<h4>Request</h4>
					<pre data-bind="visible: request, beautify: request"></pre>
				</div>
				<div data-bind="visible: result">
					<h4>Results</h4>
					<pre data-bind="visible: result, beautify: response"></pre>
				</div>
			</article>
		</li>
	</ul>

</body>
</html>